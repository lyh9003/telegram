name: Telegram Telethon Script

on:
  workflow_dispatch:
    inputs:
      limit_per_channel:
        description: '채널별 메시지 수집 개수'
        required: false
        default: '50'
        type: string
      use_gpt_analysis:
        description: 'GPT 분석 사용 여부'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 */6 * * *'  # 6시간마다 실행

jobs:
  run:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4  # v2에서 v4로 업데이트
        
      - name: Set up Python
        uses: actions/setup-python@v5  # v4에서 v5로 업데이트
        with:
          python-version: '3.11'  # 3.10에서 3.11로 업데이트
          cache: 'pip'  # pip 캐시 추가로 빌드 시간 단축
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Verify environment variables
        run: |
          echo "환경변수 확인 중..."
          if [ -z "${{ secrets.API_ID }}" ]; then
            echo "❌ API_ID가 설정되지 않았습니다."
            exit 1
          else
            echo "✅ API_ID 확인됨"
          fi
          
          if [ -z "${{ secrets.API_HASH }}" ]; then
            echo "❌ API_HASH가 설정되지 않았습니다."
            exit 1
          else
            echo "✅ API_HASH 확인됨"
          fi
          
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "⚠️ OPENAI_API_KEY가 설정되지 않았습니다. GPT 분석을 사용할 수 없습니다."
          else
            echo "✅ OPENAI_API_KEY 확인됨"
          fi
          
          if [ -z "${{ secrets.SESSION_B64 }}" ]; then
            echo "⚠️ SESSION_B64가 설정되지 않았습니다. 새 세션을 생성해야 할 수 있습니다."
          else
            echo "✅ SESSION_B64 확인됨"
          fi
          
      - name: Restore session file
        run: |
          if [ ! -z "${{ secrets.SESSION_B64 }}" ]; then
            echo "${{ secrets.SESSION_B64 }}" | base64 -d > my_session.session
            echo "세션 파일 복원 완료"
            ls -la my_session.session
          else
            echo "세션 파일이 없습니다. 새 세션을 생성합니다."
            touch my_session.session
          fi
          
      - name: Run script with error handling
        run: |
          echo "스크립트 실행 시작..."
          python tele_main.py || {
            echo "❌ 스크립트 실행 실패"
            echo "현재 디렉토리 파일 목록:"
            ls -la
            echo "Python 패키지 확인:"
            pip list | grep -E "(telethon|pandas|openai)"
            exit 1
          }
          
          # CSV 파일 생성 확인
          if [ -f "telegram_semiconductor_messages.csv" ]; then
            echo "✅ CSV 파일 생성 확인됨"
            wc -l telegram_semiconductor_messages.csv
            head -3 telegram_semiconductor_messages.csv
          else
            echo "❌ CSV 파일이 생성되지 않았습니다."
            echo "현재 디렉토리 내용:"
            ls -la
            # 빈 CSV 파일 생성
            echo "channel,sender_id,date_utc,date_local,labels,message,normalized_text,message_length,summary,keywords,sentiment" > telegram_semiconductor_messages.csv
            echo "빈 CSV 파일을 생성했습니다."
          fi
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          LIMIT_PER_CHANNEL: ${{ inputs.limit_per_channel || '50' }}
          USE_GPT_ANALYSIS: ${{ inputs.use_gpt_analysis || 'false' }}
          
      - name: Backup session file
        run: |
          if [ -f "my_session.session" ] && [ -s "my_session.session" ]; then
            base64 my_session.session > session_backup.txt
            echo "세션 파일 백업 완료"
            echo "세션 파일 크기: $(wc -c < my_session.session) bytes"
          else
            echo "⚠️ 세션 파일이 비어있거나 존재하지 않습니다."
            touch session_backup.txt
          fi
          
      - name: Create artifact for debugging
        if: failure()
        run: |
          echo "디버깅 정보 수집 중..."
          echo "=== 시스템 정보 ===" > debug_info.txt
          uname -a >> debug_info.txt
          echo "" >> debug_info.txt
          
          echo "=== Python 버전 ===" >> debug_info.txt
          python --version >> debug_info.txt
          echo "" >> debug_info.txt
          
          echo "=== 설치된 패키지 ===" >> debug_info.txt
          pip list >> debug_info.txt
          echo "" >> debug_info.txt
          
          echo "=== 환경 변수 (민감정보 제외) ===" >> debug_info.txt
          env | grep -v -E "(SECRET|TOKEN|KEY|HASH)" >> debug_info.txt
          echo "" >> debug_info.txt
          
          echo "=== 파일 목록 ===" >> debug_info.txt
          ls -la >> debug_info.txt
          echo "" >> debug_info.txt
          
          if [ -f "telegram_semiconductor_messages.csv" ]; then
            echo "=== CSV 파일 정보 ===" >> debug_info.txt
            wc -l telegram_semiconductor_messages.csv >> debug_info.txt
            head -5 telegram_semiconductor_messages.csv >> debug_info.txt
          fi
          
      - name: Upload debug artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-info
          path: debug_info.txt
          retention-days: 7
          
      - name: Upload CSV artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: telegram-data
          path: telegram_semiconductor_messages.csv
          retention-days: 30
          
      - name: Commit and push results
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 파일 크기 확인
          if [ -f "telegram_semiconductor_messages.csv" ]; then
            file_size=$(wc -c < telegram_semiconductor_messages.csv)
            line_count=$(wc -l < telegram_semiconductor_messages.csv)
            
            echo "CSV 파일 정보: ${file_size} bytes, ${line_count} lines"
            
            # 파일이 너무 크면 경고
            if [ $file_size -gt 25000000 ]; then  # 25MB
              echo "⚠️ 파일이 너무 큽니다 (${file_size} bytes). GitHub 제한을 고려해 주세요."
            fi
            
            git add telegram_semiconductor_messages.csv
            
            # 세션 백업이 있으면 추가 (보안상 권장하지 않으므로 주석처리)
            # if [ -f "session_backup.txt" ]; then
            #   git add session_backup.txt
            # fi
            
            if git diff --staged --quiet; then
              echo "변경사항이 없습니다."
            else
              commit_message="Update telegram data: ${line_count} messages ($(date '+%Y-%m-%d %H:%M:%S UTC')) [skip ci]"
              git commit -m "$commit_message"
              git push origin HEAD:main
              echo "✅ 변경사항을 커밋하고 푸시했습니다."
            fi
          else
            echo "❌ CSV 파일이 없어서 커밋하지 않습니다."
          fi
          
      - name: Summary
        if: always()
        run: |
          echo "=== 워크플로우 실행 요약 ==="
          echo "실행 시간: $(date)"
          echo "상태: ${{ job.status }}"
          
          if [ -f "telegram_semiconductor_messages.csv" ]; then
            line_count=$(wc -l < telegram_semiconductor_messages.csv)
            file_size=$(wc -c < telegram_semiconductor_messages.csv)
            echo "생성된 CSV: ${line_count} lines, ${file_size} bytes"
          else
            echo "CSV 파일이 생성되지 않았습니다."
          fi
          
          if [ -f "my_session.session" ]; then
            session_size=$(wc -c < my_session.session)
            echo "세션 파일: ${session_size} bytes"
          else
            echo "세션 파일이 없습니다."
          fi
