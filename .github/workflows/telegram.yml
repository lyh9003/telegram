name: Telegram Telethon Script

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ í—ˆìš© (ì…ë ¥ íŒŒë¼ë¯¸í„° ì œê±°)
  schedule:
    - cron: '0 */6 * * *'  # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰

# GitHub Actionsì— ì“°ê¸° ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: write
  actions: read
  pages: write
  id-token: write

jobs:
  run:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # ëª…ì‹œì  í† í° ì‚¬ìš©
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Verify environment variables
        run: |
          echo "í™˜ê²½ë³€ìˆ˜ í™•ì¸ ì¤‘..."
          if [ -z "${{ secrets.API_ID }}" ]; then
            echo "âŒ API_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          else
            echo "âœ… API_ID í™•ì¸ë¨"
          fi
          
          if [ -z "${{ secrets.API_HASH }}" ]; then
            echo "âŒ API_HASHê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          else
            echo "âœ… API_HASH í™•ì¸ë¨"
          fi
          
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "âŒ OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. GPT ë¶„ì„ì„ ìœ„í•´ í•„ìˆ˜ì…ë‹ˆë‹¤."
            exit 1
          else
            echo "âœ… OPENAI_API_KEY í™•ì¸ë¨"
          fi
          
          if [ -z "${{ secrets.SESSION_B64 }}" ]; then
            echo "âš ï¸ SESSION_B64ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆ ì„¸ì…˜ì„ ìƒì„±í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          else
            echo "âœ… SESSION_B64 í™•ì¸ë¨"
          fi
          
      - name: Restore session file
        run: |
          if [ ! -z "${{ secrets.SESSION_B64 }}" ]; then
            echo "${{ secrets.SESSION_B64 }}" | base64 -d > my_session.session
            echo "ì„¸ì…˜ íŒŒì¼ ë³µì› ì™„ë£Œ"
            ls -la my_session.session
          else
            echo "ì„¸ì…˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤."
            touch my_session.session
          fi
          
      - name: Run script with error handling
        run: |
          echo "ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘..."
          python tele_main.py || {
            echo "âŒ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨"
            echo "í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡:"
            ls -la
            echo "Python íŒ¨í‚¤ì§€ í™•ì¸:"
            pip list | grep -E "(telethon|pandas|openai)"
            exit 1
          }
          
          # CSV íŒŒì¼ ìƒì„± í™•ì¸
          if [ -f "telegram_semiconductor_messages.csv" ]; then
            echo "âœ… CSV íŒŒì¼ ìƒì„± í™•ì¸ë¨"
            wc -l telegram_semiconductor_messages.csv
            head -3 telegram_semiconductor_messages.csv
          else
            echo "âŒ CSV íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la
            # ë¹ˆ CSV íŒŒì¼ ìƒì„±
            echo "channel,sender_id,date_utc,date_local,labels,message,normalized_text,message_length,summary,keywords,sentiment" > telegram_semiconductor_messages.csv
            echo "ë¹ˆ CSV íŒŒì¼ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤."
          fi
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          
      - name: Backup session file
        run: |
          if [ -f "my_session.session" ] && [ -s "my_session.session" ]; then
            base64 my_session.session > session_backup.txt
            echo "ì„¸ì…˜ íŒŒì¼ ë°±ì—… ì™„ë£Œ"
            echo "ì„¸ì…˜ íŒŒì¼ í¬ê¸°: $(wc -c < my_session.session) bytes"
          else
            echo "âš ï¸ ì„¸ì…˜ íŒŒì¼ì´ ë¹„ì–´ìˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            touch session_backup.txt
          fi
          
      - name: Create artifact for debugging
        if: failure()
        run: |
          echo "ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘ ì¤‘..."
          echo "=== ì‹œìŠ¤í…œ ì •ë³´ ===" > debug_info.txt
          uname -a >> debug_info.txt
          echo "" >> debug_info.txt
          
          echo "=== Python ë²„ì „ ===" >> debug_info.txt
          python --version >> debug_info.txt
          echo "" >> debug_info.txt
          
          echo "=== ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ===" >> debug_info.txt
          pip list >> debug_info.txt
          echo "" >> debug_info.txt
          
          echo "=== í™˜ê²½ ë³€ìˆ˜ (ë¯¼ê°ì •ë³´ ì œì™¸) ===" >> debug_info.txt
          env | grep -v -E "(SECRET|TOKEN|KEY|HASH)" >> debug_info.txt
          echo "" >> debug_info.txt
          
          echo "=== íŒŒì¼ ëª©ë¡ ===" >> debug_info.txt
          ls -la >> debug_info.txt
          echo "" >> debug_info.txt
          
          if [ -f "telegram_semiconductor_messages.csv" ]; then
            echo "=== CSV íŒŒì¼ ì •ë³´ ===" >> debug_info.txt
            wc -l telegram_semiconductor_messages.csv >> debug_info.txt
            head -5 telegram_semiconductor_messages.csv >> debug_info.txt
          fi
          
      - name: Upload debug artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-info
          path: debug_info.txt
          retention-days: 7
          
      - name: Upload CSV artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: telegram-data
          path: telegram_semiconductor_messages.csv
          retention-days: 30
          
      - name: Commit and push results
        if: success()
        run: |
          # Git ì„¤ì •
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
          echo "í˜„ì¬ ë¸Œëœì¹˜: $(git branch --show-current)"
          
          # íŒŒì¼ í¬ê¸° í™•ì¸
          if [ -f "telegram_semiconductor_messages.csv" ]; then
            file_size=$(wc -c < telegram_semiconductor_messages.csv)
            line_count=$(wc -l < telegram_semiconductor_messages.csv)
            
            echo "CSV íŒŒì¼ ì •ë³´: ${file_size} bytes, ${line_count} lines"
            
            # íŒŒì¼ì´ ë„ˆë¬´ í¬ë©´ ê²½ê³  (GitHubëŠ” 100MB ì œí•œ)
            if [ $file_size -gt 25000000 ]; then  # 25MB
              echo "âš ï¸ íŒŒì¼ì´ í½ë‹ˆë‹¤ (${file_size} bytes). GitHub ì œí•œ(100MB)ì„ ê³ ë ¤í•´ ì£¼ì„¸ìš”."
            fi
            
            # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
            git add telegram_semiconductor_messages.csv
            
            if git diff --staged --quiet; then
              echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            else
              commit_message="ğŸ“Š Update telegram data: ${line_count} messages ($(date '+%Y-%m-%d %H:%M:%S UTC')) [skip ci]"
              
              echo "ì»¤ë°‹ ë©”ì‹œì§€: $commit_message"
              git commit -m "$commit_message"
              
              # í‘¸ì‹œ ì‹œë„ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
              max_retries=3
              retry_count=0
              
              while [ $retry_count -lt $max_retries ]; do
                echo "í‘¸ì‹œ ì‹œë„ $((retry_count + 1))/$max_retries"
                
                if git push origin HEAD:main; then
                  echo "âœ… ë³€ê²½ì‚¬í•­ì„ ì„±ê³µì ìœ¼ë¡œ í‘¸ì‹œí–ˆìŠµë‹ˆë‹¤."
                  break
                else
                  retry_count=$((retry_count + 1))
                  if [ $retry_count -lt $max_retries ]; then
                    echo "â³ í‘¸ì‹œ ì‹¤íŒ¨. 5ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤..."
                    sleep 5
                    # ìµœì‹  ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì™€ì„œ ì¶©ëŒ í•´ê²° ì‹œë„
                    git pull --rebase origin main || {
                      echo "âš ï¸ ë¦¬ë² ì´ìŠ¤ ì‹¤íŒ¨. ë‹¨ìˆœ ë¨¸ì§€ë¥¼ ì‹œë„í•©ë‹ˆë‹¤."
                      git pull origin main --no-rebase
                    }
                  else
                    echo "âŒ í‘¸ì‹œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼."
                    echo "ì•„í‹°íŒ©íŠ¸ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                  fi
                fi
              done
            fi
          else
            echo "âŒ CSV íŒŒì¼ì´ ì—†ì–´ì„œ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi
          
      - name: Summary
        if: always()
        run: |
          echo "=== ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ìš”ì•½ ==="
          echo "ğŸ• ì‹¤í–‰ ì‹œê°„: $(date)"
          echo "ğŸ“Š ìƒíƒœ: ${{ job.status }}"
          
          if [ -f "telegram_semiconductor_messages.csv" ]; then
            line_count=$(wc -l < telegram_semiconductor_messages.csv)
            file_size=$(wc -c < telegram_semiconductor_messages.csv)
            echo "ğŸ“ ìƒì„±ëœ CSV: ${line_count} lines, ${file_size} bytes"
            
            # ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
            echo ""
            echo "ğŸ“‹ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìµœê·¼ 3ê°œ ë©”ì‹œì§€):"
            if [ $line_count -gt 1 ]; then
              head -1 telegram_semiconductor_messages.csv
              echo "---"
              tail -3 telegram_semiconductor_messages.csv | head -3
            fi
          else
            echo "âŒ CSV íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi
          
          if [ -f "my_session.session" ]; then
            session_size=$(wc -c < my_session.session)
            echo "ğŸ” ì„¸ì…˜ íŒŒì¼: ${session_size} bytes"
          else
            echo "âš ï¸ ì„¸ì…˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi
          
          echo ""
          echo "ğŸ’¾ ì•„í‹°íŒ©íŠ¸ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          echo "ğŸ”„ ë‹¤ìŒ ìë™ ì‹¤í–‰: 6ì‹œê°„ í›„"
